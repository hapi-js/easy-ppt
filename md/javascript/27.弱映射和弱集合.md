# å¼±æ˜ å°„å’Œå¼±é›†åˆ

---

## åƒåœ¾å›æ”¶

===

### å¯¹è±¡çš„é‡Šæ”¾

ä¾‹å¦‚:

```javascript
let john = { name: "John" };
// è¯¥å¯¹è±¡èƒ½è¢«è®¿é—®ï¼Œjohn æ˜¯å®ƒçš„å¼•ç”¨
// è¦†ç›–å¼•ç”¨
john = null;
// è¯¥å¯¹è±¡å°†ä¼šè¢«ä»å†…å­˜ä¸­æ¸…é™¤
```

===

### æ•°ç»„ä¸­çš„å¯¹è±¡

å¦‚æœæŠŠä¸€ä¸ªå¯¹è±¡æ”¾å…¥åˆ°æ•°ç»„ä¸­ï¼Œé‚£ä¹ˆåªè¦è¿™ä¸ªæ•°ç»„å­˜åœ¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ä¹Ÿå°±å­˜åœ¨ï¼Œå³ä½¿æ²¡æœ‰å…¶ä»–å¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨ã€‚

```javascript
let john = { name: "John" };

let array = [ john ];

john = null; // è¦†ç›–å¼•ç”¨

// john è¢«å­˜å‚¨åœ¨æ•°ç»„é‡Œ, æ‰€ä»¥å®ƒä¸ä¼šè¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶
// æˆ‘ä»¬å¯ä»¥é€šè¿‡ array[0] æ¥è·å–å®ƒ
```

===

### Mapä¸­çš„å¯¹è±¡

ä½¿ç”¨å¯¹è±¡ä½œä¸ºå¸¸è§„ `Map` çš„é”®ï¼Œé‚£ä¹ˆå½“ `Map` å­˜åœ¨æ—¶ï¼Œè¯¥å¯¹è±¡ä¹Ÿå°†å­˜åœ¨ã€‚å®ƒä¼šå ç”¨å†…å­˜ï¼Œå¹¶ä¸”åº”è¯¥ä¸ä¼šè¢«ï¼ˆåƒåœ¾å›æ”¶æœºåˆ¶ï¼‰å›æ”¶ã€‚

```javascript
let john = { name: "John" };

let map = new Map();
map.set(john, "...");
john = null; // è¦†ç›–å¼•ç”¨
// john è¢«å­˜å‚¨åœ¨ map ä¸­ï¼Œ
// æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ map.keys() æ¥è·å–å®ƒ
```

---

## WeakMap

===

### å®šä¹‰

`WeakMap` å’Œ `Map` çš„ç¬¬ä¸€ä¸ªä¸åŒç‚¹å°±æ˜¯ï¼Œ`WeakMap` çš„é”®å¿…é¡»æ˜¯å¯¹è±¡ï¼Œä¸èƒ½æ˜¯åŸå§‹å€¼ï¼š

```javascript
let weakMap = new WeakMap();
let obj = {};

weakMap.set(obj, "ok"); // æ­£å¸¸å·¥ä½œï¼ˆä»¥å¯¹è±¡ä½œä¸ºé”®ï¼‰

// ä¸èƒ½ä½¿ç”¨å­—ç¬¦ä¸²ä½œä¸ºé”®
weakMap.set("test", "Whoops"); // Errorï¼Œå› ä¸º "test" ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡
```

===

### weakMapä¸­çš„å¯¹è±¡

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ weakMap ä¸­ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡ä½œä¸ºé”®ï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–å¯¹è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨ â€”â€” è¯¥å¯¹è±¡å°†ä¼šè¢«ä»å†…å­˜ï¼ˆå’Œmapï¼‰ä¸­è‡ªåŠ¨æ¸…é™¤ã€‚

```javascript
let john = { name: "John" };
let weakMap = new WeakMap();
weakMap.set(john, "...");
john = null; // è¦†ç›–å¼•ç”¨
// john è¢«ä»å†…å­˜ä¸­åˆ é™¤äº†ï¼
```

ä¸ä¸Šé¢å¸¸è§„çš„ `Map` çš„ä¾‹å­ç›¸æ¯”ï¼Œç°åœ¨å¦‚æœ `john` ä»…ä»…æ˜¯ä½œä¸º `WeakMap` çš„é”®è€Œå­˜åœ¨ â€”â€” å®ƒå°†ä¼šè¢«ä» mapï¼ˆå’Œå†…å­˜ï¼‰ä¸­è‡ªåŠ¨åˆ é™¤ã€‚

===

### ä¸æ”¯æŒè¿­ä»£

`WeakMap` ä¸æ”¯æŒè¿­ä»£ä»¥åŠ `keys()`ï¼Œ`values()` å’Œ `entries()` æ–¹æ³•ã€‚æ‰€ä»¥æ²¡æœ‰åŠæ³•è·å– `WeakMap` çš„æ‰€æœ‰é”®æˆ–å€¼ã€‚åªæœ‰ä»¥ä¸‹çš„æ–¹æ³•ï¼š

- `weakMap.get(key)`
- `weakMap.set(key, value)`
- `weakMap.delete(key)`
- `weakMap.has(key)`

---

## é¢å¤–æ•°æ®çš„å­˜å‚¨

`WeakMap` çš„ä¸»è¦åº”ç”¨åœºæ™¯æ˜¯ **é¢å¤–æ•°æ®çš„å­˜å‚¨**ã€‚

ä¸€ä¸ªç”¨æˆ·å¯¹è±¡ä½œä¸ºé”®ï¼Œå…¶è®¿é—®æ¬¡æ•°ä¸ºå€¼ã€‚å½“ä¸€ä¸ªç”¨æˆ·ç¦»å¼€æ—¶ï¼ˆè¯¥ç”¨æˆ·å¯¹è±¡å°†è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶ï¼‰ï¼Œè¿™æ—¶æˆ‘ä»¬å°±ä¸å†éœ€è¦ä»–çš„è®¿é—®æ¬¡æ•°äº†ã€‚

===

### ä½¿ç”¨map

```javascript
// ğŸ“ visitsCount.js
let visitsCountMap = new Map(); // map: user => visits count

// é€’å¢ç”¨æˆ·æ¥è®¿æ¬¡æ•°
function countUser(user) {
  let count = visitsCountMap.get(user) || 0;
  visitsCountMap.set(user, count + 1);
}
```

ä¸‹é¢æ˜¯å…¶ä»–éƒ¨åˆ†çš„ä»£ç ï¼Œå¯èƒ½æ˜¯ä½¿ç”¨å®ƒçš„å…¶å®ƒä»£ç ï¼š

```javascript
// ğŸ“ main.js
let john = { name: "John" };
countUser(john); // count his visits
// ä¸ä¹…ä¹‹åï¼Œjohn ç¦»å¼€äº†
john = null;
```

ç°åœ¨ `john` è¿™ä¸ªå¯¹è±¡åº”è¯¥è¢«åƒåœ¾å›æ”¶ï¼Œä½†ä»–ä»åœ¨å†…å­˜ä¸­ï¼Œå› ä¸ºå®ƒæ˜¯ `visitsCountMap` ä¸­çš„ä¸€ä¸ªé”®ã€‚

===

### ä½¿ç”¨WeakMap

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ `WeakMap` æ¥é¿å…è¿™æ ·çš„é—®é¢˜ï¼š

```javascript
// ğŸ“ visitsCount.js
let visitsCountMap = new WeakMap(); // weakmap: user => visits count

// é€’å¢ç”¨æˆ·æ¥è®¿æ¬¡æ•°
function countUser(user) {
  let count = visitsCountMap.get(user) || 0;
  visitsCountMap.set(user, count + 1);
}
```

ç°åœ¨æˆ‘ä»¬ä¸éœ€è¦å»æ¸…ç† `visitsCountMap` äº†ã€‚å½“ `john` å¯¹è±¡å˜æˆä¸å¯è®¿é—®æ—¶ï¼Œå³ä¾¿å®ƒæ˜¯ `WeakMap` é‡Œçš„ä¸€ä¸ªé”®ï¼Œå®ƒä¹Ÿä¼šè¿åŒå®ƒä½œä¸º `WeakMap` é‡Œçš„é”®æ‰€å¯¹åº”çš„ä¿¡æ¯ä¸€åŒè¢«ä»å†…å­˜ä¸­åˆ é™¤ã€‚

---

## æ¡ˆä¾‹ï¼šç¼“å­˜

å½“ä¸€ä¸ªå‡½æ•°çš„ç»“æœéœ€è¦è¢«è®°ä½ï¼ˆâ€œç¼“å­˜â€ï¼‰ï¼Œè¿™æ ·åœ¨åç»­çš„å¯¹åŒä¸€ä¸ªå¯¹è±¡çš„è°ƒç”¨æ—¶ï¼Œå°±å¯ä»¥é‡ç”¨è¿™ä¸ªè¢«ç¼“å­˜çš„ç»“æœã€‚

===

### Mapå®ç°

```javascript
// ğŸ“ cache.js
let cache = new Map();

// è®¡ç®—å¹¶è®°ä½ç»“æœ
function process(obj) {
  if (!cache.has(obj)) {
    let result = /* calculations of the result for */ obj;
    cache.set(obj, result);
  }
  return cache.get(obj);
}
// ç°åœ¨æˆ‘ä»¬åœ¨å…¶å®ƒæ–‡ä»¶ä¸­ä½¿ç”¨ process()
// ğŸ“ main.js
let obj = {/* å‡è®¾æˆ‘ä»¬æœ‰ä¸ªå¯¹è±¡ */};

let result1 = process(obj); // è®¡ç®—å®Œæˆ
// â€¦â€¦ç¨åï¼Œæ¥è‡ªä»£ç çš„å¦å¤–ä¸€ä¸ªåœ°æ–¹â€¦â€¦
let result2 = process(obj); // å–è‡ªç¼“å­˜çš„è¢«è®°å¿†çš„ç»“æœ
// â€¦â€¦ç¨åï¼Œæˆ‘ä»¬ä¸å†éœ€è¦è¿™ä¸ªå¯¹è±¡æ—¶ï¼š
obj = null;
console.log(cache.size); // 1ï¼ˆå•Šï¼è¯¥å¯¹è±¡ä¾ç„¶åœ¨ cache ä¸­ï¼Œå¹¶å æ®ç€å†…å­˜ï¼ï¼‰
```

===

### WeakMapå®ç°

å¦‚æœæˆ‘ä»¬ç”¨ `WeakMap` æ›¿ä»£ `Map`ï¼Œè¿™ä¸ªé—®é¢˜ä¾¿ä¼šæ¶ˆå¤±

```javascript
// ğŸ“ cache.js
let cache = new WeakMap();
// è®¡ç®—å¹¶è®°ç»“æœ
function process(obj) {
  if (!cache.has(obj)) {
    let result = /* calculate the result for */ obj;
    cache.set(obj, result);
  }
  return cache.get(obj);
}

// ğŸ“ main.js
let obj = {/* some object */};
let result1 = process(obj);
let result2 = process(obj);
// â€¦â€¦ç¨åï¼Œæˆ‘ä»¬ä¸å†éœ€è¦è¿™ä¸ªå¯¹è±¡æ—¶ï¼š
obj = null;
// æ— æ³•è·å– cache.sizeï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ª WeakMapï¼Œ
// è¦ä¹ˆæ˜¯ 0ï¼Œæˆ–å³å°†å˜ä¸º 0
// å½“ obj è¢«åƒåœ¾å›æ”¶ï¼Œç¼“å­˜çš„æ•°æ®ä¹Ÿä¼šè¢«æ¸…é™¤
```

---

## WeakSet

- ä¸ `Set` ç±»ä¼¼ï¼Œä½†æ˜¯æˆ‘ä»¬åªèƒ½å‘ `WeakSet` æ·»åŠ å¯¹è±¡ï¼ˆè€Œä¸èƒ½æ˜¯åŸå§‹å€¼ï¼‰ã€‚
- å¯¹è±¡åªæœ‰åœ¨å…¶å®ƒæŸä¸ªï¼ˆäº›ï¼‰åœ°æ–¹èƒ½è¢«è®¿é—®çš„æ—¶å€™ï¼Œæ‰èƒ½ç•™åœ¨ set ä¸­ã€‚
- è·Ÿ `Set` ä¸€æ ·ï¼Œ`WeakSet` æ”¯æŒ `add`ï¼Œ`has` å’Œ `delete` æ–¹æ³•ï¼Œä½†ä¸æ”¯æŒ `size` å’Œ `keys()`ï¼Œå¹¶ä¸”ä¸å¯è¿­ä»£ã€‚

å˜â€œå¼±ï¼ˆweakï¼‰â€çš„åŒæ—¶ï¼Œå®ƒä¹Ÿå¯ä»¥ä½œä¸ºé¢å¤–çš„å­˜å‚¨ç©ºé—´ã€‚ä½†å¹¶éé’ˆå¯¹ä»»æ„æ•°æ®ï¼Œè€Œæ˜¯é’ˆå¯¹â€œæ˜¯/å¦â€çš„äº‹å®ã€‚`WeakSet` çš„å…ƒç´ å¯èƒ½ä»£è¡¨ç€æœ‰å…³è¯¥å¯¹è±¡çš„æŸäº›ä¿¡æ¯ã€‚

===

### è¿½è¸ªè®¿é—®

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å°†ç”¨æˆ·æ·»åŠ åˆ° `WeakSet` ä¸­ï¼Œä»¥è¿½è¸ªè®¿é—®è¿‡æˆ‘ä»¬ç½‘ç«™çš„ç”¨æˆ·ï¼š

```javascript
let visitedSet = new WeakSet();

let john = { name: "John" };
let pete = { name: "Pete" };
let mary = { name: "Mary" };

visitedSet.add(john); // John è®¿é—®äº†æˆ‘ä»¬
visitedSet.add(pete); // ç„¶åæ˜¯ Pete
visitedSet.add(john); // John å†æ¬¡è®¿é—®

// visitedSet ç°åœ¨æœ‰ä¸¤ä¸ªç”¨æˆ·äº†
// æ£€æŸ¥ John æ˜¯å¦æ¥è®¿è¿‡ï¼Ÿ
console.log(visitedSet.has(john)); // true
// æ£€æŸ¥ Mary æ˜¯å¦æ¥è®¿è¿‡ï¼Ÿ
console.log(visitedSet.has(mary)); // false

john = null;

// visitedSet å°†è¢«è‡ªåŠ¨æ¸…ç†
```

`WeakMap` å’Œ `WeakSet` æœ€æ˜æ˜¾çš„å±€é™æ€§å°±æ˜¯ä¸èƒ½è¿­ä»£ï¼Œå¹¶ä¸”æ— æ³•è·å–æ‰€æœ‰å½“å‰å†…å®¹ã€‚

---

## æ€»ç»“

ï¼ˆ1ï¼‰`WeakMap` æ˜¯ç±»ä¼¼äº `Map` çš„é›†åˆï¼Œå®ƒä»…å…è®¸å¯¹è±¡ä½œä¸ºé”®ï¼Œå¹¶ä¸”ä¸€æ—¦é€šè¿‡å…¶ä»–æ–¹å¼æ— æ³•è®¿é—®å®ƒä»¬ï¼Œä¾¿ä¼šå°†å®ƒä»¬ä¸å…¶å…³è”å€¼ä¸€åŒåˆ é™¤ã€‚

ï¼ˆ2ï¼‰`WeakSet` æ˜¯ç±»ä¼¼äº `Set` çš„é›†åˆï¼Œå®ƒä»…å­˜å‚¨å¯¹è±¡ï¼Œå¹¶ä¸”ä¸€æ—¦é€šè¿‡å…¶ä»–æ–¹å¼æ— æ³•è®¿é—®å®ƒä»¬ï¼Œä¾¿ä¼šå°†å…¶åˆ é™¤ã€‚å®ƒä»¬éƒ½ä¸æ”¯æŒå¼•ç”¨æ‰€æœ‰é”®æˆ–å…¶è®¡æ•°çš„æ–¹æ³•å’Œå±æ€§ã€‚ä»…å…è®¸å•ä¸ªæ“ä½œã€‚

ï¼ˆ3ï¼‰`WeakMap` å’Œ `WeakSet` è¢«ç”¨ä½œâ€œä¸»è¦â€å¯¹è±¡å­˜å‚¨ä¹‹å¤–çš„â€œè¾…åŠ©â€æ•°æ®ç»“æ„ã€‚ä¸€æ—¦å°†å¯¹è±¡ä»ä¸»å­˜å‚¨å™¨ä¸­åˆ é™¤ï¼Œå¦‚æœè¯¥å¯¹è±¡ä»…è¢«ç”¨ä½œ `WeakMap` æˆ– `WeakSet` çš„é”®ï¼Œé‚£ä¹ˆå®ƒå°†è¢«è‡ªåŠ¨æ¸…é™¤ã€‚

---

## ç»ƒä¹ ï¼šå­˜å‚¨ "unread" æ ‡è¯†

é‡è¦ç¨‹åº¦: â˜…â˜…â˜…â˜…â˜…

è¿™é‡Œæœ‰ä¸€ä¸ª messages æ•°ç»„ï¼š

```javascript
let messages = [
  {text: "Hello", from: "John"},
  {text: "How goes?", from: "John"},
  {text: "See you soon", from: "Alice"}
];
```

ä½ çš„ä»£ç å¯ä»¥è®¿é—®å®ƒï¼Œä½†æ˜¯ message æ˜¯ç”±å…¶ä»–äººçš„ä»£ç ç®¡ç†çš„ã€‚è¯¥ä»£ç ä¼šå®šæœŸæ·»åŠ æ–°æ¶ˆæ¯ï¼Œåˆ é™¤æ—§æ¶ˆæ¯ï¼Œä½†æ˜¯ä½ ä¸çŸ¥é“è¿™äº›æ“ä½œç¡®åˆ‡çš„å‘ç”Ÿæ—¶é—´ã€‚ç°åœ¨ï¼Œä½ åº”è¯¥ä½¿ç”¨ä»€ä¹ˆæ•°æ®ç»“æ„æ¥ä¿å­˜å…³äºæ¶ˆæ¯â€œæ˜¯å¦å·²è¯»â€çš„ä¿¡æ¯ï¼Ÿè¯¥ç»“æ„å¿…é¡»å¾ˆé€‚åˆå¯¹ç»™å®šçš„ message å¯¹è±¡ç»™å‡ºâ€œå®ƒè¯»äº†å—ï¼Ÿâ€çš„ç­”æ¡ˆã€‚

ï¼ˆ1ï¼‰å½“ä¸€ä¸ªæ¶ˆæ¯è¢«ä» `messages` ä¸­åˆ é™¤åï¼Œå®ƒåº”è¯¥ä¹Ÿä»ä½ çš„æ•°æ®ç»“æ„ä¸­æ¶ˆå¤±ã€‚

ï¼ˆ2ï¼‰æˆ‘ä»¬ä¸èƒ½ä¿®æ”¹ message å¯¹è±¡ï¼Œä¾‹å¦‚å‘å…¶æ·»åŠ æˆ‘ä»¬çš„å±æ€§ã€‚

===

### ç­”æ¡ˆ

è®©æˆ‘ä»¬å°†å·²è¯»æ¶ˆæ¯å­˜å‚¨åœ¨ `WeakSet` ä¸­ï¼š

```javascript
let messages = [
  {text: "Hello", from: "John"},
  {text: "How goes?", from: "John"},
  {text: "See you soon", from: "Alice"}
];

let readMessages = new WeakSet();

// ä¸¤ä¸ªæ¶ˆæ¯å·²è¯»
readMessages.add(messages[0]);
readMessages.add(messages[1]);
// readMessages åŒ…å«ä¸¤ä¸ªå…ƒç´ 

// â€¦â€¦è®©æˆ‘ä»¬å†è¯»ä¸€éç¬¬ä¸€æ¡æ¶ˆæ¯ï¼
readMessages.add(messages[0]);
// readMessages ä»ç„¶æœ‰ä¸¤ä¸ªä¸é‡å¤çš„å…ƒç´ 

// å›ç­”ï¼šmessage[0] å·²è¯»ï¼Ÿ
console.log("Read message 0: " + readMessages.has(messages[0])); // true

messages.shift();
// ç°åœ¨ readMessages æœ‰ä¸€ä¸ªå…ƒç´ ï¼ˆæŠ€æœ¯ä¸Šæ¥è®²ï¼Œå†…å­˜å¯èƒ½ç¨åæ‰ä¼šè¢«æ¸…ç†ï¼‰
```

å®ƒä¼šè‡ªåŠ¨æ¸…ç†è‡ªèº«ã€‚ä»£ä»·æ˜¯ï¼Œæˆ‘ä»¬ä¸èƒ½å¯¹å®ƒè¿›è¡Œè¿­ä»£ï¼Œä¹Ÿä¸èƒ½ç›´æ¥ä»ä¸­è·å–â€œæ‰€æœ‰å·²è¯»æ¶ˆæ¯â€ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡éå†æ‰€æœ‰æ¶ˆæ¯ï¼Œç„¶åæ‰¾å‡ºå­˜åœ¨äº set çš„é‚£äº›æ¶ˆæ¯æ¥å®Œæˆè¿™ä¸ªåŠŸèƒ½ã€‚

---

## ç»ƒä¹ ï¼šä¿å­˜é˜…è¯»æ—¥æœŸ

é‡è¦ç¨‹åº¦: â˜…â˜…â˜…â˜…â˜…

è¿™å„¿æœ‰ä¸€ä¸ªå’Œ ä¸Šä¸€ä¸ªä»»åŠ¡ ç±»ä¼¼çš„ `messages` æ•°ç»„ã€‚åœºæ™¯ä¹Ÿç›¸ä¼¼ã€‚

```javascript
let messages = [
  {text: "Hello", from: "John"},
  {text: "How goes?", from: "John"},
  {text: "See you soon", from: "Alice"}
];
```

ç°åœ¨çš„é—®é¢˜æ˜¯ï¼šä½ å»ºè®®é‡‡ç”¨ä»€ä¹ˆæ•°æ®ç»“æ„æ¥ä¿å­˜ä¿¡æ¯ï¼šâ€œæ¶ˆæ¯æ˜¯ä»€ä¹ˆæ—¶å€™è¢«é˜…è¯»çš„ï¼Ÿâ€ã€‚

åœ¨å‰ä¸€ä¸ªä»»åŠ¡ä¸­æˆ‘ä»¬åªéœ€è¦ä¿å­˜â€œæ˜¯/å¦â€ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦ä¿å­˜æ—¥æœŸï¼Œå¹¶ä¸”å®ƒåº”è¯¥åœ¨æ¶ˆæ¯è¢«åƒåœ¾å›æ”¶æ—¶ä¹Ÿè¢«ä»å†…å­˜ä¸­æ¸…é™¤ã€‚

P.S. æ—¥æœŸå¯ä»¥å­˜å‚¨ä¸ºå†…å»ºçš„ `Date` ç±»çš„å¯¹è±¡ï¼Œç¨åæˆ‘ä»¬å°†è¿›è¡Œä»‹ç»ã€‚

===

### ç­”æ¡ˆ

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `WeakMap` ä¿å­˜æ—¥æœŸï¼š

```javascript
let messages = [
  {text: "Hello", from: "John"},
  {text: "How goes?", from: "John"},
  {text: "See you soon", from: "Alice"}
];

let readMap = new WeakMap();

readMap.set(messages[0], new Date(2017, 1, 1));
// æˆ‘ä»¬ç¨åå°†å­¦ä¹  Date å¯¹è±¡
```